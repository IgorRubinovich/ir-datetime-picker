<!-- 
@license
Copyright (c) 2015 Igor Rubinovich <igor.rubinovich@gmail.com>. All rights reserved.
This code may only be used under the MIT license found at http://opensource.org/licenses/MIT
-->
<!--
# ir-datetime-picker
# Tagging-style multiselect box for Polymer 1.0
-->

<dom-module id="ir-datetime-picker">
  <link rel="import" href="../iron-pages/iron-pages.html">
  <link rel="import" href="../paper-tabs/paper-tabs.html">
  <link rel="import" href="../paper-button/paper-button.html">
  <link rel="import" href="../paper-dialog/paper-dialog.html">
  <link rel="import" href="../paper-time-picker/paper-time-picker.html">
  <link rel="import" href="../paper-date-picker/paper-date-picker.html">
  <script src="../moment/min/moment-with-locales.min.js"></script>
  <style>
    :host {
      display: block;
    }

    @media (max-width: 600px) {
      h1.paper-font-display1 {
        font-size: 24px;
      }
    } 
	
	paper-dialog-scrollable paper-button, #non-prompt-opener {
	}
	
	#non-prompt-opener {
		border : 1px solid #ddd;
	}
	
	paper-dialog-scrollable {
		display : flex;
		flex-wrap : wrap;
	}
	
	
	
  </style>
  <template>
    <paper-button raised$="{{ !readOnly }}" disabled$="{{ readOnly }}" hidden$="{{ onlyTime }}" on-tap="open" target-page="date">{{ _date }}</paper-button>
    <paper-button raised$="{{ !readOnly }}" disabled$="{{ readOnly }}" hidden$="{{ onlyDate }}" hidden$="{{ onlyDate }}" on-tap="open" target-page="time"><span>{{ _time }}</span></paper-button>
    <paper-dialog id="dialog" responsive-width="{{ responsiveWidth }}">
		<div>
			<paper-tabs on-selected-changed="refitDialog" selected="{{ selectedPage }}" attr-for-selected="target-page">
				<paper-tab hidden$="{{ onlyTime }}" target-page="date">{{ _previewDate }}</paper-tab>
				<paper-tab hidden$="{{ onlyDate }}" target-page="time">{{ _previewTime }}</paper-tab>
			</iron-tabs>
		</div>
		<iron-pages on-tap="previewUpdate" attr-for-selected="page" selected="{{ selectedPage }}">
			<paper-date-picker hidden$="timeOnly" 
				id="datepicker" 
				page="date" 
				responsive-width="{{ responsiveWidth }}" 
				prompt-dialog-source
				min-year="{{minYear}}" 
				max-year="{{maxYear}}" 
				years="{{years}}"
				min-date="{{minDate}}" 
				max-date="{{maxDate}}"
				on-date-changed="previewUpdate"
				hidden$="{{ onlyTime }}"
				>
			</paper-date-picker>
			<paper-time-picker 
				id="timepicker" 
				class="paper-time-picker-dialog" 
				page="time" 
				responsive-width="{{ responsiveWidth }}" 
				hidden$="{{ onlyDate }}"
				></paper-time-picker>
			</paper-time-picker>
		</iron-pages>
	  <div class="buttons">
		<paper-button dialog-dismiss on-tap="cancel">Cancel</paper-button>
		<paper-button dialog-confirm on-tap="promptUpdate">OK</paper-button>
	  </div>
	</paper-dialog>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'ir-datetime-picker',

        properties: {
		  /* paper-date-picker properties */
          minYear : { type : Number },
          maxYear : { type : Number },
          years : { type : Number },
          minDate : { type : Number },
          maxDate : { type : Number },

		  /* paper-date-picker and paper-time-picker layout width */
          responsiveWidth : { type : Number },
		  
		  promptMode : {
			type : Boolean,
			value : false,
			notify : true
		  },
		  
		  title : {
			type : String,
			value : "",
			notify : true
		  },

		  /* Selected date or undefined. Declared as object to make undefined possible. It is convenient to interpret a no-value (empty form value) as current server time. */
		  date : {
			type : Object,
			notify : true,
			observer : "_valueChanged"
		  },
		  
		  unixTime : {
			type : String,
			value : '',
			notify : true,
			observer : "_unixTimeChanged"
		  },
		  
		  formatDate : {
			type : String,
			value : "ll"
		  },
		  
		  formatTime : {
			type : String,
			value : "LT"
		  },
		  
		  onlyDate : {
			type : Boolean,
			value : false
		  },
		  
		  onlyTime : {
			type : Boolean,
			value : false
		  },
		  
		  readOnly : {
			type : Boolean,
			value : false
		  },
		  
		  /* momentjs locale */
		  locale : {
			type : String,
			value : "en"
		  },
		  
		  /* timeZone - see moment.js/utcOffset for format */
		  timeZone : { type : String, value : "0" },
		  
		  /* the actual display date */
		  _date : { type : Number, value : undefined},
		  messagePickDate : { type : String, value : "pick date" },

		  /* the actual display time */
		  _time : { type : Number, value : "pick date" },
		  messagePickTime : { type : String, value : "pick time" },

		  /* preview display time */
		  _hour : { type : Number, value : "pick time"  },
		  _minute :  { type : Number }
        },
		
		observers : [
			"_onlyChanged(onlyDate,onlyTime,readOnly)"
		],
		
		_onlyChanged : function() {
			if(this.onlyDate && this.onlyTime)
				throw new Error("only-date and only-time can't be true simultaneously");				
		},
		
		open : function(ev)
		{
			// this.date = this.date || moment().utcOffset(this.timeZone);
			var d = moment(this.date).utcOffset(this.timeZone),
				targetPage, 
				pureDate;
				
			pureDate = d.hours(0).minutes(0).seconds(0).milliseconds(0).toDate();
				
			d = moment(this.date).utcOffset(this.timeZone);

			this.set("date", pureDate, this.$.datepicker);
			
			this.set("minute", d.minutes(), this.$.timepicker);
			this.set("hour", d.hours(), this.$.timepicker);

			targetPage = ev.currentTarget.getAttribute("target-page");
			
			if(this.onlyTime) targetPage = "time";
			if(this.onlyDate) targetPage = "date";
			
			this.set("selectedPage", targetPage);
			
			this.previewUpdate(true);
			
			this.$.dialog.open();

			this.refitDialog();
			
			this.prevValue = this.value;
		},

		refitDialog : function() {
			this.async(function() {
				this.$.dialog.refit();
				this.$.dialog.constrain();
				this.$.dialog.center();
			});
		},

		prompt : function(callback)
		{
			if(!this.promptMode)
				throw new Error("must be in prompt mode to use .prompt");

			this.promptCallback = callback;
			this.open()
		},
		
		close : function()
		{
			this.promptUpdate();
			this.$.dialog.close();
		},

		cancel : function(ev)
		{
			this.value = this.prevValue;
		},

		promptUpdate : function()
		{
			//if(!(this.$.datepicker.date && this.$.timepicker.hour && this.$.timepicker.minute))
			//	return;
			var m, relUnix;
			//d = moment();
			
			relUnix = this.$.datepicker.date.getTime() + (24*60*60 + (this.$.timepicker.hour + 1)*60*60 + this.$.timepicker.minute*60)*1000 // ms in utc
			m = moment().utcOffset(0).set(relUnix); // moment object in utc
			this.unixTime = relUnix
			this.date = new Date(this.unixTime);

			this.value = this.unixTime;
			
			this.fire("change");
			
			this.viewUpdate();
			
			if(this.promptMode)
			{
				this.promptCallback(this.value);
				delete this.promptCallback;
				this.inPromptMode = false;
			}
		},
		
		/* update the actual control view (date and/or time buttons) visible in the page */
		viewUpdate : function() {
			var d = moment().set(this.date).utcOffset(this.timeZone).locale(this.locale),
					date, time;

			if(typeof this.date == 'undefined' || this.date == null)
			{
				date = this.messagePickDate;
				time = this.messagePickTime;
			}
			else
			{
				date = d.format(this.formatDate);
				time = d.format(this.formatTime);
			}

			this.set("_date", date);
			this.set("_time", time);
		},
		 
		/* update values of dialog inputs */
		previewUpdate : function(fromValue) {
			var h, m, previewTime,
				d = moment.unix(this.$.datepicker.date.getTime()/1000 + (this.$.timepicker.hour)*60*60 + this.$.timepicker.minute*60);

			if(!d.isValid() || fromValue)
				d = moment(this.date).utcOffset(this.timeZone || 0);

			//moment
			//	.unix(Number(moment(this.date).format("X")) + this.$.timepicker.hour * 60 * 60 + this.$.timepicker.minute * 60)

			h = d.hours(),
			m = d.minutes();

			if(!d.format)
				return;

			this.set("_previewDate", d.format(this.formatDate));
			this.set("_previewTime", d.format(this.formatTime));
		},
		
		attached : function() {
			this.viewUpdate();
			if(this.opened)
				this.open();
				
			//this.previewUpdate();
		},
		_unixTimeChanged : function() {
			if(this.unixTime != '')
				this.date = new Date(Number(this.unixTime)); //new Date(Number(this.unixTime)); //Date.UTC.apply(this, moment(0).toArray()); //new Date(this.unixTime);
		},
		
		_valueChanged : function(oldv, newv) {
			// console.log(oldv, newv);  
		}
      });	  
    })();
  </script>

</dom-module>
